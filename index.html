import asyncio
import logging
import json
import urllib.parse
from datetime import datetime
from aiogram import Bot, Dispatcher, types, F
from aiogram.filters import Command
from aiogram.types import InlineKeyboardButton, InlineKeyboardMarkup, WebAppInfo, ReplyKeyboardMarkup, KeyboardButton
from apscheduler.schedulers.asyncio import AsyncIOScheduler

# --- –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø ---
API_TOKEN = '8342216853:AAF-_LtBQejUR1Wx9FS9mA0dmWPZuiEei58'
ADMIN_ID = 6889016268
COURIER_CHAT_ID = -1003843457222
WEB_APP_URL = "https://myshchyshyn9898-bit.github.io/delivery-bot/" 

logging.basicConfig(level=logging.INFO)

bot = Bot(token=API_TOKEN)
dp = Dispatcher()
scheduler = AsyncIOScheduler(timezone="Europe/Warsaw")
orders_db = []

# --- –°–¢–ê–†–¢ ---
@dp.message(Command("start"))
async def start_cmd(message: types.Message):
    kb = ReplyKeyboardMarkup(keyboard=[
        [KeyboardButton(text="üìù –°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è", web_app=WebAppInfo(url=WEB_APP_URL))]
    ], resize_keyboard=True)
    await message.answer("üëá –ù–∞—Ç–∏—Å–Ω–∏ –∫–Ω–æ–ø–∫—É –í–ù–ò–ó–£ –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è:", reply_markup=kb)

# --- –û–ë–†–û–ë–ö–ê –ó–ê–ú–û–í–õ–ï–ù–ù–Ø ---
@dp.message(F.content_type == types.ContentType.WEB_APP_DATA)
async def web_app_data_handler(message: types.Message):
    try:
        data = json.loads(message.web_app_data.data)
        
        # –û—Ç—Ä–∏–º—É—î–º–æ –¥–∞–Ω—ñ
        address = data['address']
        apt = data.get('apt', '-')
        floor = data.get('floor', '-')
        phone = data.get('phone', '-')
        notes = data.get('notes', '') # –ü—Ä–∏–º—ñ—Ç–∫–∏ (–º–æ–∂—É—Ç—å –±—É—Ç–∏ –ø—É—Å—Ç—ñ)
        pay_type = data['payType']

        # –§–æ—Ä–º–∞—Ç—É—î–º–æ –æ–ø–ª–∞—Ç—É (–ì–æ—Ç—ñ–≤–∫—É –≤–∏–¥—ñ–ª—è—î–º–æ –∂–∏—Ä–Ω–∏–º —ñ –∑–Ω–∞–∫–æ–º –æ–∫–ª–∏–∫—É)
        if pay_type == 'cash':
            amount = float(data['sum'])
            money_str = f"üíµ **–ì–æ—Ç—ñ–≤–∫–∞:** ‚ùóÔ∏è __{amount:.2f} z≈Ç__ ‚ùóÔ∏è"
        else:
            amount = 0
            money_str = f"üí≥ **–û–ø–ª–∞—Ç–∞:** –û–ù–õ–ê–ô–ù (–°–ø–ª–∞—á–µ–Ω–æ)"

        # –§–æ—Ä–º—É—î–º–æ –ø—Ä–∏–º—ñ—Ç–∫–∏ (—è–∫—â–æ —î)
        notes_str = f"\nüìù **–Ü–Ω—Ñ–æ:** {notes}" if notes else ""

        # --- –ö–†–ê–°–ò–í–ò–ô –î–ò–ó–ê–ô–ù –ü–û–í–Ü–î–û–ú–õ–ï–ù–ù–Ø ---
        courier_text = (
            f"üì¶ **–ù–û–í–ï –ó–ê–ú–û–í–õ–ï–ù–ù–Ø**\n"
            f"‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n"
            f"üìç **{address}**\n\n"
            f"üö™ **–ö–≤:** {apt}   ü™ú **–ü–æ–≤:** {floor}\n"
            f"üìû **–¢–µ–ª:** `{phone}`\n"
            f"{notes_str}\n\n"
            f"{money_str}\n"
            f"‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ"
        )

        # –ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –∫–∞—Ä—Ç—É (–£–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–µ)
        encoded_addr = urllib.parse.quote(address)
        maps_url = f"https://www.google.com/maps/search/?api=1&query={encoded_addr}"
        
        callback_data = f"close_{pay_type}_{amount}"
        
        kb_courier = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="üó∫ –ú–∞—Ä—à—Ä—É—Ç", url=maps_url)],
            [InlineKeyboardButton(text="‚úÖ –ó–∞–∫—Ä–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è", callback_data=callback_data)]
        ])

        await bot.send_message(COURIER_CHAT_ID, courier_text, reply_markup=kb_courier, parse_mode="Markdown")
        await message.answer(f"‚úÖ –û–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–æ!")
        
    except Exception as e:
        print(f"‚ùå –ü–û–ú–ò–õ–ö–ê: {e}")
        await message.answer(f"–ü–æ–º–∏–ª–∫–∞: {e}")

# --- –ó–ê–ö–†–ò–¢–¢–Ø ---
@dp.callback_query(F.data.startswith("close_"))
async def close_order(callback: types.CallbackQuery):
    try:
        parts = callback.data.split("_")
        p_type = parts[1]
        amount = float(parts[2])
        courier = callback.from_user.first_name

        original_text = callback.message.text
        time_now = datetime.now().strftime("%H:%M")
        
        # –ó–º—ñ–Ω—é—î–º–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–∞ "–ó–∞–∫—Ä–∏—Ç–æ"
        new_text = original_text.replace("üì¶ **–ù–û–í–ï –ó–ê–ú–û–í–õ–ï–ù–ù–Ø**", f"üî¥ **–ó–ê–ö–†–ò–¢–û** ({time_now} - {courier})")
        # –ü—Ä–∏–±–∏—Ä–∞—î–º–æ –∫–Ω–æ–ø–∫–∏
        await callback.message.edit_text(new_text, reply_markup=None)

        orders_db.append({"courier": courier, "type": p_type, "amount": amount})
        await callback.answer(f"–ü—Ä–∏–π–Ω—è—Ç–æ! {amount} z≈Ç.")
    except Exception as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ –∑–∞–∫—Ä–∏—Ç—Ç—è: {e}")

# --- –ó–í–Ü–¢ ---
async def send_daily_report():
    if not orders_db: return
    stats = {}
    total_cash = 0
    for o in orders_db:
        name = o['courier']
        if name not in stats: stats[name] = {"cash": 0, "online": 0, "total": 0}
        stats[name]["total"] += 1
        if o['type'] == 'cash':
            stats[name]["cash"] += o['amount']
            total_cash += o['amount']
        else:
            stats[name]["online"] += 1

    report = "üìä **–ó–í–Ü–¢ (23:00)**\n‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n\n"
    for name, d in stats.items():
        report += f"üë§ **{name}**: {d['total']} –∑–∞–º. | {d['cash']:.2f} z≈Ç\n"
    report += f"‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\nüí∞ **–í–°–Ø –ö–ê–°–ê:** {total_cash:.2f} z≈Ç"
    await bot.send_message(COURIER_CHAT_ID, report, parse_mode="Markdown")
    orders_db.clear()

scheduler.add_job(send_daily_report
